##
# isos_inject
#
# @version 0.1
DEBUG ?= 0
CC = gcc
ifeq ($(DEBUG), 0)
	CFLAGS = -Wall -Wextra -Wno-unused -std=c17 -O2 -Warray-bounds -Wsequence-point \
			-Walloc-zero -Wnull-dereference -Wpointer-arith -Wcast-qual -Wcast-align=strict
			
	CPPFLAGS =
else
	CFLAGS = -Wall -Wextra -Wno-unused -std=c11 -O0 -g -fsanitize=undefined -fsanitize=address
	CPPFLAGS =  -DDEBUG
endif
LDFLAGS = -lelf

TEST_CLANG_FLAGS = -fsyntax-only -Wall -Wextra -Wuninitialized -Wpointer-arith -Wcast-qual -Wcast-align
TEST_GCC_FLAGS = -fsyntax-only -fanalyzer -Wanalyzer-too-complex 

SOURCES=isos_inject.c elf_util.c elf_util.h

all: isos_inject

isos_inject: isos_inject.o elf_util.o
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

isos_inject.o: isos_inject.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $<
	clang $(TEST_CLANG_FLAGS) $<
	gcc $(TEST_GCC_FLAGS) $<

elf_util.o: elf_util.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $<
	clang $(TEST_CLANG_FLAGS) $<
	gcc $(TEST_GCC_FLAGS) $<

clean:
	rm -f *- *.o isos_inject

check: $(SOURCES)
	clang-tidy $(CPPFLAGS) -checks="cert-*" --warnings-as-errors="*" $(SOURCES)

help:
	@echo "usage:"
	@echo "  make [all]\t\tbuild the software"
	@echo "  make clean\t\tremove all files generated by make"
	@echo "  make help\t\tdisplay this help"

.phony: all clean help

# end
